"use strict";var _createClass=function(){function s(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}define(["SwiftOtter_Test/js/stripe-management.babel","SwiftOtter_Test/js/renderer/slide/next-button.babel","SwiftOtter_Test/js/renderer/slide/previous-button.babel","SwiftOtter_Test/js/ga.babel","SwiftOtter_Theme/js/field.babel","SwiftOtter_Test/js/api.babel","SwiftOtter_Test/js/token-management.babel"],function(o,e,a,r,n,s,l){function i(e,t,n){var s='\n          <li class="test-question test-question--payment test-question--payment" data-question-id="'+this.data.id+'">\n            <div class="payment__details">\n              <div class="payment__value-prop">\n                  <h2 class="test-question__title">'+this.data.question+'</h2>\n                  <div class="test-question__subtext">'+this.data.subtext+'</div>\n                </div>\n                <div class="payment__form">\n                    <ul class="payment__choice">\n                        <li class="payment__one-choice">\n                            <label class="payment__choice--selected">\n                                <input type="radio" class="payment__choice-option" value="once" name="payment__choice-option" checked="checked"/>\n                                <div class="payment__selector"></div>\n                                <span><b>One take</b><br/><br/>'+jsonConfig.formatted_price+'</span>\n                            </label>\n                        </li>\n                        <li class="payment__unlimited-choice">\n                            <label>\n                                <input type="radio" class="payment__choice-option" value="month" name="payment__choice-option" />\n                                <div class="payment__selector"></div>\n                                <span>1 month of<br/><b>unlimited takes</b><br/><br/>'+jsonConfig.formatted_price_unlimited+'</span>\n                            </label>\n                        </li>\n                    </ul>\n                    \n                  <div class="test-question__payment-request-button"></div>\n                  <div class="test-question__payment-submit">\n                      <div class="test-question__payment-details">\n                          <div class="test-question__payment-email">\n                            <div class="field">\n                                <label class="label" for="payment-name">Name</label>\n                                <input type="text" class="input-text" id="payment-name'+this.data.id+'" value="'+(localStorage.hasOwnProperty("name")?localStorage.name:"")+'"></label>\n                            </div>\n                            <div class="field">\n                                <label class="label" for="payment-email">Email</label>\n                                <input type="email" class="input-text" id="payment-email'+this.data.id+'" value="'+(localStorage.hasOwnProperty("email")?localStorage.email:"")+'"></label>\n                            </div>\n                            <div class="field payment__password">\n                                <label class="label" for="payment-password">\n                                <span class="payment__password-tologin-preface">Your Login </span>Password</span>\n                                <br/><small class="payment__password-note">the entered email is already registered, so you need to login</small>\n                                <small class="payment__password-toregister">for a new account</small>\n                                </label>\n                                <input type="password" class="input-text" id="payment-password'+this.data.id+'"></label>\n                            </div>\n                          </div>\n                          <div class="test-question__payment-card"></div>\n                      </div>\n                      <div class="test-question__payment-button">\n                      <div class="test-question__payment-errors"></div>\n                      <button class="test-question__pay test-question__cta-button info-button">'+this.config.icons.secure+' <span class="payment__action-login" style="display: none">Login and </span>Pay</button>\n                      Payments secured by Stripe. 1 month of unlimited takes is <b>not</b> a subscription. You will only be charged once.\n                      </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div class="test-question__buttons">\n              <h3 class="test-question__payment-alternate">OR</h3>\n              <button class="test-question__goto-survey test-question__cta-button info-button" data-question-id="'+this.data.id+'">To Grade Free Test</button>\n              '+a(this.data,e,t)+"\n            </div>\n          </li>";return document.createRange().createContextualFragment(s).firstElementChild}function c(){var t=this;this.el.querySelector(".test-question__pay").addEventListener("click",function(e){return y.call(t,e)}),Array.prototype.forEach.call(this.el.querySelectorAll(".field"),function(e){return n({},e)}),Array.prototype.forEach.call(this.el.querySelectorAll(".payment__choice-option"),function(e){return e.addEventListener("change",function(e){var t=e.currentTarget;Array.prototype.forEach.call(this.el.querySelectorAll(".payment__choice label"),function(e){return e.classList.remove("payment__choice--selected")}),t.parentNode.classList.add("payment__choice--selected"),p.call(this)}.bind(t))}),this.el.querySelector('[id="payment-email'+this.data.id+'"]').addEventListener("change",d.bind(this))}function d(){var t=this,e=this.el.querySelector('[id="payment-email'+this.data.id+'"]').value;e?this.api.needsToLogin(e).then(function(e){t.needsToLogin=e,p.call(t)}):p.call(this)}function u(){return!this.needsToLogin&&this.el.querySelector('[value="month"]').checked}function p(){var e=u.call(this);!this.needsToLogin&&!e||jsonConfig.logged_in?this.el.querySelector(".payment__password").style.display="none":(this.el.querySelector(".payment__password").style.display="block",this.el.querySelector(".payment__password-note").style.display="none",this.needsToLogin&&(this.el.querySelector(".payment__password-note").style.display="inline"),e?(this.el.querySelector(".payment__password-toregister").style.display="inline",this.el.querySelector(".payment__password-tologin-preface").style.display="none",this.el.querySelector(".payment__action-login").style.display="none"):(this.el.querySelector(".payment__password-toregister").style.display="none",this.el.querySelector(".payment__password-tologin-preface").style.display="inline",this.el.querySelector(".payment__action-login").style.display="inline"))}function y(e){var t=this;e.preventDefault();var n=this.el.querySelector("#payment-email"+this.data.id).value,s=this.el.querySelector("#payment-name"+this.data.id).value;(function(t){var n=this,e=this.el.querySelector("#payment-email"+this.data.id).value,s=this.el.querySelector("#payment-name"+this.data.id).value,a=this.el.querySelector("#payment-password"+this.data.id).value;if(!e||!s)return!(this.el.querySelector(".test-question__payment-errors").textContent="You must specify your name and email.");if(-1===e.indexOf("@"))return!(this.el.querySelector(".test-question__payment-errors").textContent="You must specify a valid email.");if(-1===s.indexOf(" "))return!(this.el.querySelector(".test-question__payment-errors").textContent="You must specify a first and last name (separated by a space).");if(this.needsToLogin&&!a)return!(this.el.querySelector(".test-question__payment-errors").textContent="You must specify a password.");if(this.needsToLogin&&!jsonConfig.logged_in)return m.call(this),l.login(e,a).then(function(e){e.success?(n.needsToLogin=!1,y.call(n,t)):(_().call(n),n.el.querySelector(".test-question__payment-errors").textContent=e.error)}),!1;if(u.call(this)&&!jsonConfig.logged_in){var i=s.split(" ");return m.call(this),l.register(e,a,i[0],i[1]).then(function(e){e.success?(n.needsToLogin=!1,y.call(n,t)):(_.call(n),n.el.querySelector(".test-question__payment-errors").textContent=e.error)}),!1}return!0}).call(this,e)&&(localStorage.name=s,localStorage.email=n,m.call(this),o.getStripe().createToken(this.card,{name:s,country:jsonConfig.hasOwnProperty("country")?jsonConfig.country:"United States"}).then(function(e){e.error?(_.call(t),t.el.querySelector(".test-question__payment-errors").textContent=e.error.message):(t.el.querySelector(".test-question__payment-errors").innerText="",function(e){var n=this,t=this.el.querySelector("#payment-email"+this.data.id).value,s=this.el.querySelector("#payment-name"+this.data.id).value,a="USD",i="66048";window.hasOwnProperty("jsonConfig")&&jsonConfig.hasOwnProperty("currency_code")&&(a=jsonConfig.currency_code);e.hasOwnProperty("card")&&e.card.hasOwnProperty("address_zip")&&e.card.address_zip&&(i=e.card.address_zip);var l="once";this.el.querySelector('[value="month"]').checked&&(l="month");o.createOrder(e.id,t,s,i,a,l).then(function(e){if(_.call(n),e.hasOwnProperty("message"))n.el.querySelector(".test-question__payment-errors").innerText=e.message;else{r.purchase(e.order_number,e.test.base_price);var t=new CustomEvent("test:reloadData",{detail:{testData:e.test,details:e,from:n.data.id}});document.body.dispatchEvent(t)}})}.call(t,e.token))}))}function m(){this.el.querySelector(".payment__details").classList.add("is-loading")}function _(){this.el.querySelector(".payment__details").classList.remove("is-loading")}return function(){function n(e,t){_classCallCheck(this,n),this.config=e,this.data=t,this.elements=o.getStripe().elements(),this.api=new s(e),this.needsToLogin=!1}return _createClass(n,[{key:"render",value:function(e,t,n){return this.el=i.call(this,e,t,n),c.call(this),function(){var t=this,e=this.elements.create("card",{style:{base:{color:"#32325d",lineHeight:"18px",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#32325d"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}});(this.card=e).mount(this.el.querySelector(".test-question__payment-card")),e.addEventListener("change",function(e){document.getElementById("card-errors"),e.error?t.el.querySelector(".test-question__payment-errors").textContent=e.error.message:t.el.querySelector(".test-question__payment-errors").textContent=""})}.call(this),d.call(this),jsonConfig.hasOwnProperty("has_unlimited_price")&&jsonConfig.has_unlimited_price||(this.el.querySelector(".payment__choice").style.display="none"),this.el}}]),n}()});